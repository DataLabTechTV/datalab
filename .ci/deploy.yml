spec:
  inputs:
    force_services_deploy:
      description: "Force a deploy of the services docker compose project"
      type: boolean
      default: false
    force_apps_deploy:
      description: "Force a deploy of the apps docker compose project"
      type: boolean
      default: false

---

services_deploy:
  stage: deploy
  image: docker:28.4.0-cli
  variables:
    DOCKER_HOST: tcp://docker-shared:2375
  script:
    - docker compose -p datalab -f infra/services/docker/compose.yml up -d
    - docker ps
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - infra/services/docker/**/*
    - if: '"$[[ inputs.force_services_deploy ]]" == "true"'
      when: manual

apps_deploy:
  stage: deploy
  image: docker:28.4.0-cli
  variables:
    DOCKER_HOST: tcp://docker-apps:2375
  script:
    - docker compose -p datalab -f infra/apps/docker/compose.yml up -d --build
    - docker ps
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - infra/apps/docker/**/*
    - if: '"$[[ inputs.force_apps_deploy ]]" == "true"'
      when: manual
