spec:
  inputs:
    db_user:
      description: "PostgreSQL username to create and grant privileges to"
      type: string
    db_name:
      description: "PostgreSQL database to create"
      type: string

---

psql_load_credentials:
  stage: postgres
  before_script:
    - add-apt-repository universe
    - apt update
    - apt install -y jq
  script:
    - .ci/scripts/postgres/load_credentials.sh
  artifacts:
    reports:
      dotenv: credentials.env
  rules:
    - if: '"$[[ inputs.db_user ]]" != ""'
    - when: never

psql_create_user:
  stage: postgres
  image: docker:28.4.0-cli
  variables:
    DOCKER_HOST: tcp://docker-shared:2375
  before_script:
    - apk add --no-cache openssl
  script:
    - ./ci/scripts/postgres/create_user.sh
  artifacts:
    reports:
      dotenv: credentials.env
  needs:
    - psql_load_credentials
  rules:
    - if: '"$[[ inputs.db_user ]]" != ""'
    - when: never

psql_create_db:
  stage: postgres
  image: docker:28.4.0-cli
  variables:
    DOCKER_HOST: tcp://docker-shared:2375
  script:
    - .ci/scripts/postgres/create_db.sh
  artifacts:
    reports:
      dotenv: credentials.env
  needs:
    - psql_create_user
  rules:
    - if: '"$[[ inputs.db_name ]]" != ""'
    - when: never
